#!/usr/bin/env bash

function main() {
    mkdir -p ~/.composer
    mkdir -p ~/.npm
    mkdir -p ~/.ssh

    local version=latest name=${PWD##*/} xampp=$(dirname "$0")/
    local XDEBUG_REMOTE_HOST=$(ip -4 addr show scope global dev docker0 | grep inet | awk '{print $2}' | cut -d / -f 1)
    [[ $1 == :* ]] && {
        version=$(echo "$1"| cut -d':' -f 2)
        shift
    }

    "${xampp}"/xampp-env

    # mount directories' symbolic links which are outside of the base directory as volumes to the container
    local base=${PWD} volumes link candidate relative
    for link in $(find "${base}" -type l); do
        candidate=$(readlink -f "${link}")
        [[ -d ${candidate} ]] && [[  ${candidate} != ${base}/* ]] && {
            relative=${link:${#base}+1:100}
            volumes="${volumes} --volume ${candidate}:/app/${relative}"
        }
    done;

    mkdir -p ~/.local/share/xampp/"${name}"
    touch ~/.local/share/xampp/"${name}"/.bash_history

    docker start "${name}" 2>/dev/null || docker run -td --rm --expose 3000 --net local \
        --name "${name}" \
        --hostname ".${name}" \
        --label "traefik.http.routers.$name.rule=Host(\`$name.localhost\`)" \
        --label "traefik.http.routers.$name.service=$name" \
        --label "traefik.http.services.$name.loadbalancer.server.port=80" \
        --label "traefik.http.routers.$name.middlewares=https-redirect@docker" \
        --label "traefik.http.routers.$name.tls=true" \
        --env XDEBUG_REMOTE_HOST="${XDEBUG_REMOTE_HOST}" \
        --env "ACCOUNT=https://$name.localhost" \
        --volume ~/.local/share/xampp/"${name}"/.bash_history:/home/app/.bash_history \
        --volume ~/.composer:/home/app/.composer \
        --volume ~/.npm:/home/app/.npm \
        --volume ~/.gitconfig:/home/app/.gitconfig:ro \
        --volume ~/.ssh:/home/app/.ssh:ro \
        --volume $(pwd):/app \
        --volume $(pwd):/opt/project \
        ${volumes} \
        "$@" \
        "xampp/app:${version}"

    docker exec -ti -u $UID "${name}" bash
}

main "$@"
